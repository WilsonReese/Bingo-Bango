<div class="d-flex justify-content-end mb-2">
  <button type="button" class="btn btn-primary" style="--bs-btn-padding-y: .1rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .5rem;" >
    Selected
  </button>
  <button type="button" class="btn btn-outline-primary" style="--bs-btn-padding-y: .1rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .5rem;" >
    Can Select
  </button>
</div>

<div class="table-container">
  <table class="table-calendar">
    <thead>
      <tr>
        <th scope="col">Time</th>
        <% @theaters.each do |theater| %>
          <th scope="col">Theater <%= theater.id %></th>
        <% end %>
      </tr>
    </thead>
    <tbody >
      <% (10..23).each do |hour| %>
        <% (0..3).each do |quarter| %>
          <% time = Time.current.change(hour: hour, min: quarter * 15) %>
          <% next_time = time + 15.minutes %>
          <tr>
            <th scope="row">
              <%= time.strftime("%l:%M %p - ") %>
              <%= next_time.strftime("%l:%M %p") %>
            </th>
            <% @theaters.each do |theater| %>
              <td>
                <% if !theater.interval_reserved?(hour, quarter) && !(time < Time.current) %>
                  <div class="d-flex justify-content-center align-items-center" style="height: 100%;">
                    <% if !start_time && !end_time %>
                      <%= link_to new_reservation_path(start_time: "#{hour}:#{quarter * 15}", theater_id: theater.id) do %>
                        <button type="button" class="btn btn-outline-primary" style="--bs-btn-padding-y: .1rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .5rem;">
                          <%= time.strftime("%l:%M %p") %> Start
                        </button>
                      <% end %>
                    <% elsif start_time && !end_time %>
                      <% if theater.id != theater_id %>
                        <div class="d-flex justify-content-center align-items-center" style="height: 100%;">
                          <button type="button" class="btn btn-outline-secondary" style="--bs-btn-padding-y: .1rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .5rem;" disabled>
                            Available
                          </button>
                        </div>
                      <% else %>
                        <!-- Start Time Selected, The cell is before the current time (I AM NOT SURE THIS WORKS) -->
                        <% if start_time > time %>
                          <button type="button" class="btn btn-outline-secondary" style="--bs-btn-padding-y: .1rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .5rem;" disabled>
                            Available
                          </button>
                        <% end %>

                        <!-- Start Time Selected, The Cell is the Start Time -->
                        <% if @reservation.selected_start_time?(hour, quarter) %>
                          <%= link_to new_reservation_path(start_time: start_time, theater_id: theater_id, end_time: next_time) do %>
                            <button type="button" class="btn btn-primary" style="--bs-btn-padding-y: .1rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .5rem;">
                              <%= next_time.strftime("%l:%M %p")%> End
                            </button>
                          <% end %>
                        <% end %>

                        <% if theater.next_reservation_after(start_time) %> <!-- Checks if there is a next reservation -->
                          <!-- Start Time Selected, The cell is after the start_time and after a reservation -->
                          <% if theater.next_reservation_after(start_time).start_time < time && time > start_time %>
                            <button type="button" class="btn btn-outline-secondary" style="--bs-btn-padding-y: .1rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .5rem;" disabled>
                              Available
                            </button>
                          <% end %>
                          
                          <!-- Start Time Selected, The cell is after the start_time and before next reseravation -->
                          <% if !(theater.next_reservation_after(start_time).start_time < time) && time > start_time %>
                            <%= link_to new_reservation_path(start_time: start_time, theater_id: theater_id, end_time: next_time) do %>
                              <button type="button" class="btn btn-outline-primary" style="--bs-btn-padding-y: .1rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .5rem;">
                                <%= next_time.strftime("%l:%M %p")%> End
                              </button>
                            <% end %>
                          <% end %>
                        <% else %>
                          <% if time > start_time %>
                            <%= link_to new_reservation_path(start_time: start_time, theater_id: theater_id, end_time: next_time) do %>
                              <button type="button" class="btn btn-outline-primary" style="--bs-btn-padding-y: .1rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .5rem;">
                                <%= next_time.strftime("%l:%M %p")%> End
                              </button>
                            <% end %>
                          <% end %>
                        <% end %>
                      <% end %>
                    <!-- After End time is Selected -->
                    <% else %>
                      <% if theater.id != theater_id %>
                        <div class="d-flex justify-content-center align-items-center" style="height: 100%;">
                          <button type="button" class="btn btn-outline-secondary" style="--bs-btn-padding-y: .1rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .5rem;" disabled>
                            Available
                          </button>
                        </div>
                      <% else %>
                        <!-- Start time is after the current time, time is available but unselectable -->
                        <% if start_time > time %>
                          <button type="button" class="btn btn-outline-secondary" style="--bs-btn-padding-y: .1rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .5rem;" disabled>
                            Available
                          </button>
                        <% end %>

                        <!-- interval (time) is start time or later AND interval (next_time) is end time or earlier -->
                        <% if time >= start_time && next_time <= end_time %>
                          <%= link_to new_reservation_path(start_time: start_time, theater_id: theater_id, end_time: next_time) do %>
                            <button type="button" class="btn btn-primary" style="--bs-btn-padding-y: .1rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .5rem;">
                              <%= start_time.strftime("%l:%M %p") %> - <%= end_time.strftime("%l:%M %p") %>
                            </button>
                          <% end %>
                        <% end %>

                        <% if theater.next_reservation_after(end_time) %>
                          <!-- interval is after end_time && before next reservation -->
                          <% if time < theater.next_reservation_after(end_time).start_time && time >= end_time %>
                            <%= link_to new_reservation_path(start_time: start_time, theater_id: theater_id, end_time: next_time) do %>
                              <button type="button" class="btn btn-outline-primary" style="--bs-btn-padding-y: .1rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .5rem;">
                                <%= next_time.strftime("%l:%M %p")%> End
                              </button>
                            <% end %>
                          <% end %>

                          <!-- interval is after end_time && after next reservation -->
                          <% if !(time < theater.next_reservation_after(end_time).start_time) && time >= end_time %>
                            <button type="button" class="btn btn-outline-secondary" style="--bs-btn-padding-y: .1rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .5rem;" disabled>
                              Available
                            </button>
                          <% end %>
                        <% else %>
                          <% if time >= end_time %>
                            <%= link_to new_reservation_path(start_time: start_time, theater_id: theater_id, end_time: next_time) do %>
                              <button type="button" class="btn btn-outline-primary" style="--bs-btn-padding-y: .1rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .5rem;">
                                <%= next_time.strftime("%l:%M %p")%> End
                              </button>
                            <% end %>
                          <% end %>
                        <% end %>
                      <% end %>
                    <% end %>
                  </div>
                <% else %>
                  <div class="d-flex justify-content-center align-items-center" style="height: 100%;">
                    <button type="button" class="btn btn-secondary" style="--bs-btn-padding-y: .1rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .5rem;" disabled>
                      Unavailable
                    </button>
                  </div>
                <% end %>
              </td>
            <% end %>
          </tr>
        <% end %>
      <% end %>
    </tbody>
  </table>
</div>
